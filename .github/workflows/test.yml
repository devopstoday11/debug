name: Tests
"on":
    pull_request: {}
jobs:
    package:
        name: Package Test
        runs-on:
            - ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-go@v2
              with:
                go-version: "1.15"
            - uses: actions/cache@v2
              with:
                key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum','**/buildpack.toml') }}
                path: |-
                    ~/go/pkg/mod
                    ~/carton-cache
                restore-keys: ${{ runner.os }}-go-
            - name: Install pack
              run: |-
                curl \
                	--location \
                	--show-error \
                	--silent \
                	"https://github.com/buildpacks/pack/releases/download/v${{ env.PACK_VERSION }}/pack-v${{ env.PACK_VERSION }}-linux.tgz" \
                	| sudo tar -C /usr/local/bin/ --no-same-owner -xzv pack
              env:
                PACK_VERSION: 0.13.1
            - name: Create Package
              run: |-
                go get -ldflags="-s -w" github.com/paketo-buildpacks/libpak/cmd/create-package
                create-package \
                	--cache-location ~/carton-cache \
                	--destination ~/buildpack \
                	--include-dependencies \
                	--version "${{ github.sha }}"

                [[ -e package.toml ]] && cp package.toml > ~/package.toml
                printf '[buildpack]\nuri = "%s"' "$(realpath ~/buildpack)" >> ~/package.toml
            - name: Package Buildpack
              run: |-
                pack package-buildpack \
                	test/package \
                	--config ~/package.toml
    unit:
        name: Unit Test
        runs-on:
            - ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-go@v2
              with:
                go-version: "1.15"
            - uses: actions/cache@v2
              with:
                key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                path: ~/go/pkg/mod
                restore-keys: ${{ runner.os }}-go-
            - name: Install richgo
              run: go get -u github.com/kyoh86/richgo
            - name: Run Tests
              run: richgo test ./...
              env:
                RICHGO_FORCE_COLOR: "1"
